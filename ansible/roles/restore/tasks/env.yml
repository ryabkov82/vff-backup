---
# Считываем секреты на контроллере (localhost), кладём в факты

- name: "Secrets | Check restic password exists on controller"
  delegate_to: localhost
  run_once: true
  ansible.builtin.stat:
    path: "{{ restic_pass_file }}"
  register: restic_pass_stat

- name: "Secrets | Fail if restic password missing"
  when: not restic_pass_stat.stat.exists
  ansible.builtin.fail:
    msg: "Restic password not found on controller: {{ restic_pass_file }}"

- name: "Secrets | Read restic password (controller)"
  delegate_to: localhost
  run_once: true
  no_log: true
  ansible.builtin.slurp:
    src: "{{ restic_pass_file }}"
  register: restic_pass_slurp

- name: "Secrets | Check MinIO secret exists on controller"
  delegate_to: localhost
  run_once: true
  ansible.builtin.stat:
    path: "{{ minio_secret_file }}"
  register: minio_secret_stat

- name: "Secrets | Fail if MinIO secret missing"
  when: not minio_secret_stat.stat.exists
  ansible.builtin.fail:
    msg: "MinIO user secret not found on controller: {{ minio_secret_file }}"

- name: "Secrets | Read MinIO secret (controller)"
  delegate_to: localhost
  run_once: true
  no_log: true
  ansible.builtin.slurp:
    src: "{{ minio_secret_file }}"
  register: minio_secret_slurp

- name: "Secrets | Set facts"
  no_log: true
  ansible.builtin.set_fact:
    restic_password: "{{ restic_pass_slurp.content | b64decode | trim }}"
    minio_secret: "{{ minio_secret_slurp.content | b64decode | trim }}"
