- name: Env dir
  ansible.builtin.file:
    path: "{{ backup_env_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0750"

- name: Env file
  ansible.builtin.template:
    src: restic.env.j2
    dest: "{{ backup_env_file }}"
    owner: root
    group: root
    mode: "0640"

- name: Init restic repository if missing
  when: not ansible_check_mode
  ansible.builtin.shell: |
    set -euo pipefail
    set -a; source "{{ backup_env_file }}"; set +a
    restic snapshots >/dev/null 2>&1 || restic init
  args:
    executable: /bin/bash
  register: restic_init
  changed_when: restic_init.rc == 0 and (restic_init.stdout is search('created restic repository') or restic_init.stderr is search('created restic repository'))
